<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Indoor Map + Barcode + Invoice</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Camera Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --text:#e8eefc;
      --muted:#a9b6d4;
      --line:#223457;
      --primary:#2f6bff;
      --success:#00c853;
      --danger:#ff4d4f;
      --warning:#ffb020;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, rgba(47,107,255,.25), transparent 55%),
                  radial-gradient(900px 500px at 20% 0%, rgba(0,200,83,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
      -webkit-text-size-adjust: 100%;
    }

    .app{
      min-height: 100vh;
      min-height: 100dvh;
      display:flex;
      flex-direction:column;
      gap: 12px;
      padding: 12px;
    }

    .controls{
      background: linear-gradient(180deg, rgba(17,31,59,.95), rgba(15,27,51,.95));
      border: 1px solid rgba(34,52,87,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .brand{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(11,18,32,.45);
      border: 1px solid rgba(34,52,87,.7);
      margin-bottom: 10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .brand h1{ margin:0; font-size: 15px; line-height: 1.4; }
    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(47,107,255,.18);
      border: 1px solid rgba(47,107,255,.35);
      color: var(--text);
      white-space:nowrap;
      margin-top: 2px;
    }

    .nav{
      display:flex;
      gap: 10px;
      margin: 10px 0 10px;
    }
    .tab{
      flex:1;
      border: 1px solid rgba(34,52,87,.9);
      background: rgba(11,18,32,.4);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(47,107,255,.35), rgba(47,107,255,.12));
      border-color: rgba(47,107,255,.55);
    }

    .section{
      background: rgba(11,18,32,.35);
      border: 1px solid rgba(34,52,87,.75);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .section h2{ margin:0 0 10px; font-size: 14px; }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; }

    .field{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    label{ font-size: 12px; color: var(--muted); }

    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,52,87,.95);
      background: rgba(11,18,32,.55);
      color: var(--text);
      outline:none;
      font-size: 16px;
    }
    input::placeholder{ color: rgba(169,182,212,.7); }

    .btn{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,52,87,.95);
      background: rgba(11,18,32,.45);
      color: var(--text);
      cursor:pointer;
      transition:.15s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{ background: linear-gradient(180deg, rgba(47,107,255,.95), rgba(31,79,209,.92)); border-color: rgba(47,107,255,.7); }
    .btn.success{ background: linear-gradient(180deg, rgba(0,200,83,.9), rgba(0,150,62,.9)); border-color: rgba(0,200,83,.55); }
    .btn.danger{ background: linear-gradient(180deg, rgba(255,77,79,.9), rgba(200,40,42,.9)); border-color: rgba(255,77,79,.55); }
    .btn.warning{ background: linear-gradient(180deg, rgba(255,176,32,.92), rgba(200,130,20,.92)); border-color: rgba(255,176,32,.55); color:#0b1220; font-weight:700; }
    .mini{ width:auto; padding: 10px 10px; font-size: 13px; }
    .hint{ font-size: 12px; color: var(--muted); line-height: 1.6; margin: 6px 0 0; }
    .divider{ border:0; border-top: 1px solid rgba(34,52,87,.75); margin: 10px 0; }

    .main{
      flex:1;
      background: linear-gradient(180deg, rgba(17,31,59,.55), rgba(15,27,51,.35));
      border: 1px solid rgba(34,52,87,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(34,52,87,.85);
      background: rgba(11,18,32,.35);
      gap: 8px;
      flex-wrap:wrap;
    }
    .badge{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(11,18,32,.55);
      border: 1px solid rgba(34,52,87,.9);
      color: var(--text);
    }

    .content{
      padding: 12px;
      min-height: 0;
      flex:1;
      position: relative;
    }

    .page{
      display:block;
      height:100%;
      opacity:0;
      pointer-events:none;
      position:absolute;
      inset:0;
    }
    .page.active{
      opacity:1;
      pointer-events:auto;
      position:relative;
    }

    #map{
      height: 60vh;
      height: 60dvh;
      min-height: 420px;
      border-radius: 14px;
      border: 1px solid rgba(34,52,87,.85);
      overflow:hidden;
      background: rgba(11,18,32,.25);
      touch-action: manipulation;
    }

    .scannerCard{
      background: rgba(11,18,32,.35);
      border: 1px solid rgba(34,52,87,.85);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .scanResult{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,52,87,.85);
      background: rgba(11,18,32,.45);
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
    }

    .scanArea{ position: relative; width: 100%; max-width: 560px; margin: 0 auto; }
    #reader{ width: 100%; max-width: 560px; margin: 0 auto; }

    .scanOverlay{
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: grid;
      place-items: center;
      opacity: 0;
      transition: .2s;
    }
    .scanOverlay.on{ opacity: 1; }

    .scanFrame{
      width: min(88%, 420px);
      height: min(35%, 200px);
      border: 2px solid rgba(255,255,255,0.65);
      border-radius: 14px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.12);
    }
    .laser{
      width: calc(min(88%, 420px) - 16px);
      height: 3px;
      border-radius: 999px;
      background: rgba(255, 0, 0, 0.88);
      box-shadow: 0 0 12px rgba(255,0,0,0.75);
      position: absolute;
      transform: translateY(calc(-0.5 * min(35%, 200px) + 8px));
      animation: laserMove 1.6s linear infinite;
    }
    @keyframes laserMove{
      0%   { transform: translateY(calc(-0.5 * min(35%, 200px) + 8px)); }
      50%  { transform: translateY(calc( 0.5 * min(35%, 200px) - 8px)); }
      100% { transform: translateY(calc(-0.5 * min(35%, 200px) + 8px)); }
    }

    /* ===== Toast ===== */
    .toastWrap{
      position: fixed;
      bottom: 14px;
      left: 14px;
      right: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      z-index: 9999;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      background: rgba(15,27,51,.92);
      border: 1px solid rgba(34,52,87,.85);
      box-shadow: var(--shadow);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.5;
    }
    .toast.good{ border-color: rgba(0,200,83,.6); }
    .toast.bad{ border-color: rgba(255,77,79,.6); }
    .toast.warn{ border-color: rgba(255,176,32,.6); }

    /* ===== Modal ===== */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9998;
    }
    .modalBack.on{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: rgba(15,27,51,.98);
      border: 1px solid rgba(34,52,87,.85);
      box-shadow: var(--shadow);
      border-radius: 16px;
      padding: 14px;
    }
    .modal h3{ margin:0 0 10px; font-size: 16px; }
    .modal p{ margin:0 0 10px; color: var(--muted); font-size: 13px; line-height: 1.6; }
    .modal .row{ margin-top: 10px; }

    /* Invoice */
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border: 1px solid rgba(34,52,87,.75);
    }
    .table th, .table td{
      padding: 10px;
      border-bottom: 1px solid rgba(34,52,87,.55);
      font-size: 13px;
      text-align: right;
      vertical-align: middle;
    }
    .table th{ color: var(--muted); font-weight:700; background: rgba(11,18,32,.35); }
    .table tr:last-child td{ border-bottom: none; }
    .qtyBtns{ display:flex; gap: 8px; justify-content:flex-start; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34,52,87,.75);
      background: rgba(11,18,32,.45);
      font-size: 12px;
    }

    @media (min-width: 981px){
      .app{
        display:grid;
        grid-template-columns: 360px 1fr;
        gap: 16px;
        padding: 16px;
        min-height: 100vh;
        min-height: 100dvh;
      }
      .controls{
        position: sticky;
        top: 16px;
        height: calc(100vh - 32px);
        overflow:auto;
      }
      #map{
        height: calc(100vh - 32px - 56px - 24px);
        min-height: 560px;
      }
    }
  </style>
</head>

<body>
  <div class="toastWrap" id="toastWrap" aria-live="polite"></div>

  <!-- Login Modal (Phone + OTP) -->
  <div class="modalBack" id="loginModal">
    <div class="modal">
      <h3>تسجيل دخول</h3>
      <p>ادخل رقم الهاتف لإرسال كود. (هذه نسخة تجريبية: سيتم عرض الكود داخل الصفحة بدل SMS. لرسائل SMS الحقيقية تحتاج Backend مثل Firebase/Twilio).</p>

      <div class="field">
        <label>رقم الهاتف</label>
        <input id="phone" placeholder="مثال: 0591234567" inputmode="tel" />
      </div>

      <div class="row">
        <button class="btn primary" id="sendOtp" type="button">إرسال الكود</button>
        <button class="btn" id="skipLogin" type="button">دخول تجريبي</button>
      </div>

      <div id="otpBox" style="display:none; margin-top:12px;">
        <div class="field">
          <label>أدخل الكود</label>
          <input id="otp" placeholder="000000" inputmode="numeric" />
        </div>
        <div class="row">
          <button class="btn success" id="verifyOtp" type="button">تحقق</button>
        </div>
        <p class="hint" id="otpHint"></p>
      </div>
    </div>
  </div>

  <!-- Admin PIN Modal -->
  <div class="modalBack" id="adminModal">
    <div class="modal">
      <h3>دخول الإدارة</h3>
      <p>أدخل رقم الإدارة (PIN) لفتح أدوات الإدارة. لن يظهر هذا للزبون.</p>
      <div class="field">
        <label>Admin PIN</label>
        <input id="adminPin" placeholder="****" inputmode="numeric" />
      </div>
      <div class="row">
        <button class="btn success" id="adminLogin" type="button">دخول</button>
        <button class="btn" id="adminCancel" type="button">إلغاء</button>
      </div>
      <p class="hint">لتغيير الـ PIN عدّل المتغير <code>ADMIN_PIN</code> داخل الكود.</p>
    </div>
  </div>

  <div class="app">
    <!-- CONTROLS -->
    <aside class="controls">
      <div class="brand" id="brandArea" title="اضغط مطولاً للدخول للإدارة">
        <div>
          <h1>نظام خريطة متجر + باركود + فاتورة</h1>
          <div class="hint">بحث بالاسم/الباركود، كاميرا Barcode، صفحة فاتورة</div>
        </div>
        <span class="pill" id="modeBadge">الوضع: مستخدم</span>
      </div>

      <div class="nav">
        <button class="tab active" id="tabMap" type="button">الخريطة</button>
        <button class="tab" id="tabScan" type="button">الكاميرا</button>
        <button class="tab" id="tabBill" type="button">الفاتورة</button>
      </div>

      <!-- USER SEARCH -->
      <div class="section">
        <h2>بحث المستخدم</h2>

        <div class="field">
          <label>بحث بالاسم أو الباركود</label>
          <input id="q" placeholder="مثال: حليب أو 629100..." />
        </div>

        <div class="row">
          <button class="btn primary" id="go" type="button">اذهب إلى المنتج</button>
          <button class="btn" id="setMe" type="button">حدد موقعي (اضغط على الخريطة)</button>
        </div>

        <p class="hint">الكاميرا تحتاج HTTPS. GitHub Pages يوفر HTTPS تلقائيًا.</p>
      </div>

      <!-- ADMIN (hidden until admin login) -->
      <div class="section admin-only" style="display:none;">
        <h2>إدارة شبكة الممرات</h2>
        <div class="row">
          <button class="btn mini" id="addNode" type="button">أضف نقطة</button>
          <button class="btn mini" id="addEdge" type="button">اربط نقطتين</button>
          <button class="btn mini" id="stopMode" type="button">إيقاف</button>
        </div>
        <hr class="divider">
        <div class="row">
          <button class="btn mini success" id="saveGraph" type="button">حفظ الشبكة</button>
          <button class="btn mini" id="loadGraph" type="button">تحميل الشبكة</button>
          <button class="btn mini danger" id="clearGraph" type="button">مسح الشبكة</button>
        </div>
        <p class="hint">في وضع الإدارة: النقاط يتم “سناب” داخل حدود الخريطة لتكون قريبة ومنطقية.</p>
      </div>

      <div class="section admin-only" style="display:none;">
        <h2>إدارة المنتجات (منع التكرار)</h2>
        <div class="field">
          <label>Barcode (إجباري)</label>
          <input id="sku" placeholder="629100..." inputmode="numeric" />
        </div>
        <div class="field">
          <label>اسم المنتج (إجباري)</label>
          <input id="pname" placeholder="مثال: حليب" />
        </div>
        <div class="field">
          <label>سعر المنتج (إجباري)</label>
          <input id="pprice" placeholder="مثال: 7.5" inputmode="decimal" />
        </div>

        <div class="row">
          <button class="btn success" id="addProduct" type="button">إضافة/تحديث منتج (اضغط على الخريطة)</button>
        </div>

        <hr class="divider">
        <div class="row">
          <button class="btn mini success" id="saveProducts" type="button">حفظ المنتجات</button>
          <button class="btn mini" id="loadProducts" type="button">تحميل المنتجات</button>
          <button class="btn mini danger" id="clearProducts" type="button">مسح المنتجات</button>
        </div>

        <p class="hint">ممنوع تكرار المنتج: لا اسم مكرر ولا باركود مكرر. (التحديث يتم على نفس المنتج بدل تكراره).</p>
      </div>

      <div class="section admin-only" style="display:none;">
        <h2>إدارة</h2>
        <div class="row">
          <button class="btn danger" id="adminLogout" type="button">خروج من الإدارة</button>
        </div>
      </div>

      <div class="section">
        <h2>تنبيه مهم</h2>
        <p class="hint">لا تفتح الملف كـ (file://). استخدم GitHub Pages (HTTPS) لكي تعمل الكاميرا على Safari.</p>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="badge" id="statusText">جاهز</div>
        <div class="badge" id="buildModeText">وضع الممرات: متوقف</div>
      </div>

      <div class="content">
        <!-- MAP PAGE -->
        <section class="page active" id="pageMap">
          <div id="map"></div>
        </section>

        <!-- SCAN PAGE -->
        <section class="page" id="pageScan">
          <div class="scannerCard">
            <h2 style="margin:0 0 10px; font-size:16px;">فحص الباركود بالكاميرا</h2>

            <div class="scanArea">
              <div id="reader"></div>
              <div class="scanOverlay" id="scanOverlay" aria-hidden="true">
                <div class="scanFrame"></div>
                <div class="laser"></div>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="startScan" type="button">تشغيل (بحث/إضافة للفاتورة)</button>
              <button class="btn" id="stopScan" type="button">إيقاف</button>
              <button class="btn" id="useManual" type="button">إدخال يدوي</button>
              <button class="btn success admin-only" id="scanToAdd" type="button" style="display:none;">
                مسح لإضافة/تحديث منتج
              </button>
            </div>

            <p class="hint">
              عند مسح المنتج: سيتم إضافته للفواتير تلقائيًا (كمية +1). <br>
              في وضع الإدارة: زر "مسح لإضافة/تحديث منتج" يضع الباركود داخل خانة الإدارة لتثبيت المنتج على الخريطة.
            </p>
          </div>

          <div class="scannerCard">
            <h2 style="margin:0 0 10px; font-size:16px;">النتيجة</h2>
            <div class="scanResult" id="scanResult">لا يوجد قراءة بعد.</div>
          </div>
        </section>

        <!-- BILL PAGE -->
        <section class="page" id="pageBill">
          <div class="scannerCard">
            <h2 style="margin:0 0 10px; font-size:16px;">الفاتورة</h2>

            <div class="row" style="margin-bottom:10px;">
              <span class="chip" id="billCount">عدد الأصناف: 0</span>
              <span class="chip" id="billTotal">المجموع: 0</span>
            </div>

            <div style="overflow:auto; border-radius:12px;">
              <table class="table" id="billTable">
                <thead>
                  <tr>
                    <th>المنتج</th>
                    <th>السعر</th>
                    <th>الكمية</th>
                    <th>الإجمالي</th>
                    <th>تحكم</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn danger" id="clearBill" type="button">تفريغ الفاتورة</button>
            </div>

            <hr class="divider">

            <h2 style="margin:0 0 10px; font-size:16px;">الدفع (محاكاة)</h2>
            <div class="row">
              <button class="btn success" id="payCash" type="button">دفع نقدًا</button>
              <button class="btn primary" id="payCard" type="button">دفع بطاقة</button>
            </div>
            <p class="hint">هذه أزرار محاكاة فقط. ربط الدفع الحقيقي يحتاج بوابة دفع + سيرفر.</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // =============================
    // Config
    // =============================
    const ADMIN_PIN = "1234"; // غيّرها
    const SNAP_GRID = 6;      // سناب بسيط للنقاط (كل 6px على الخريطة)
    const MAP_MARGIN = 6;     // يمنع وضع نقاط على الحواف
    const ALLOW_NAME_DUPLICATE = false; // ممنوع تكرار الاسم

    // =============================
    // Toast
    // =============================
    const toastWrap = document.getElementById("toastWrap");
    function toast(msg, type="good"){
      const el = document.createElement("div");
      el.className = "toast " + (type || "");
      el.textContent = msg;
      toastWrap.appendChild(el);
      setTimeout(() => { el.style.opacity = "0"; el.style.transition = "opacity .25s"; }, 2600);
      setTimeout(() => { el.remove(); }, 3000);
    }

    // =============================
    // Pages (Tabs)
    // =============================
    const tabMap = document.getElementById("tabMap");
    const tabScan = document.getElementById("tabScan");
    const tabBill = document.getElementById("tabBill");
    const pageMap = document.getElementById("pageMap");
    const pageScan = document.getElementById("pageScan");
    const pageBill = document.getElementById("pageBill");

    function showPage(name){
      const isMap = (name === "map");
      const isScan = (name === "scan");
      const isBill = (name === "bill");

      pageMap.classList.toggle("active", isMap);
      pageScan.classList.toggle("active", isScan);
      pageBill.classList.toggle("active", isBill);

      tabMap.classList.toggle("active", isMap);
      tabScan.classList.toggle("active", isScan);
      tabBill.classList.toggle("active", isBill);

      document.body.offsetHeight;

      location.hash = isMap ? "#map" : isScan ? "#scan" : "#bill";

      if (isMap) {
        setTimeout(() => map.invalidateSize(true), 150);
        setTimeout(() => map.invalidateSize(true), 500);
      }
    }

    tabMap.addEventListener("click", (e) => { e.preventDefault(); stopScanner(true); showPage("map"); setStatus("صفحة الخريطة"); });
    tabScan.addEventListener("click", (e) => { e.preventDefault(); showPage("scan"); setStatus("صفحة الكاميرا"); });
    tabBill.addEventListener("click", (e) => { e.preventDefault(); stopScanner(true); showPage("bill"); setStatus("صفحة الفاتورة"); renderBill(); });

    window.addEventListener("load", () => {
      if (location.hash === "#scan") showPage("scan");
      else if (location.hash === "#bill") showPage("bill");
      else showPage("map");
    });

    window.addEventListener("hashchange", () => {
      if (location.hash === "#scan") showPage("scan");
      else if (location.hash === "#bill") showPage("bill");
      else showPage("map");
    });

    // =============================
    // Status UI
    // =============================
    const statusText = document.getElementById("statusText");
    const buildModeText = document.getElementById("buildModeText");
    const adminEls = document.querySelectorAll(".admin-only");
    const scanOverlay = document.getElementById("scanOverlay");

    function setStatus(msg){ statusText.textContent = msg; }
    function setBuildMode(msg){ buildModeText.textContent = msg; }
    function overlayOn(){ if (scanOverlay) scanOverlay.classList.add("on"); }
    function overlayOff(){ if (scanOverlay) scanOverlay.classList.remove("on"); }

    // =============================
    // Login (Phone + OTP) - Demo
    // =============================
    const loginModal = document.getElementById("loginModal");
    const phoneInput = document.getElementById("phone");
    const sendOtpBtn = document.getElementById("sendOtp");
    const verifyOtpBtn = document.getElementById("verifyOtp");
    const skipLoginBtn = document.getElementById("skipLogin");
    const otpBox = document.getElementById("otpBox");
    const otpHint = document.getElementById("otpHint");
    const otpInput = document.getElementById("otp");

    let loggedIn = false;
    let otpCode = null;

    function openLogin(){ loginModal.classList.add("on"); }
    function closeLogin(){ loginModal.classList.remove("on"); }

    function normalizePhone(p){
      return (p || "").replace(/[^\d]/g, "");
    }

    sendOtpBtn.addEventListener("click", () => {
      const p = normalizePhone(phoneInput.value);
      if (p.length < 9) { toast("أدخل رقم هاتف صحيح.", "bad"); return; }
      otpCode = String(Math.floor(100000 + Math.random()*900000));
      otpBox.style.display = "block";
      // نسخة تجريبية: نعرض الكود بدل SMS
      otpHint.textContent = "كود تجريبي (بدل SMS): " + otpCode;
      toast("تم إرسال الكود (تجريبي).", "good");
    });

    verifyOtpBtn.addEventListener("click", () => {
      const v = (otpInput.value || "").trim();
      if (!otpCode) { toast("اضغط إرسال الكود أولاً.", "warn"); return; }
      if (v !== otpCode) { toast("الكود غير صحيح.", "bad"); return; }
      loggedIn = true;
      localStorage.setItem("logged_in_v1", "1");
      closeLogin();
      toast("تم تسجيل الدخول.", "good");
    });

    skipLoginBtn.addEventListener("click", () => {
      loggedIn = true;
      localStorage.setItem("logged_in_v1", "1");
      closeLogin();
      toast("تم الدخول تجريبيًا.", "warn");
    });

    // =============================
    // Admin Hidden Mode (Long press + PIN)
    // =============================
    const adminModal = document.getElementById("adminModal");
    const adminPinInput = document.getElementById("adminPin");
    const adminLoginBtn = document.getElementById("adminLogin");
    const adminCancelBtn = document.getElementById("adminCancel");
    const brandArea = document.getElementById("brandArea");
    const modeBadge = document.getElementById("modeBadge");
    const adminLogoutBtn = document.getElementById("adminLogout");
    const scanToAddBtn = document.getElementById("scanToAdd");

    let isAdmin = false;
    let pressTimer = null;

    function openAdmin(){ adminModal.classList.add("on"); adminPinInput.value = ""; adminPinInput.focus(); }
    function closeAdmin(){ adminModal.classList.remove("on"); }

    function applyModeUI() {
      modeBadge.textContent = isAdmin ? "الوضع: إدارة" : "الوضع: مستخدم";
      adminEls.forEach(el => el.style.display = isAdmin ? "block" : "none");
      if (scanToAddBtn) scanToAddBtn.style.display = isAdmin ? "flex" : "none";
      if (!isAdmin) {
        mode = "none";
        selectedForEdge = null;
        pickingProduct = false;
        pendingProduct = null;
        setBuildMode("وضع الممرات: متوقف");
      }
    }

    brandArea.addEventListener("touchstart", () => {
      pressTimer = setTimeout(() => openAdmin(), 900); // ضغط مطوّل 0.9 ثانية
    }, {passive:true});
    brandArea.addEventListener("touchend", () => { clearTimeout(pressTimer); }, {passive:true});
    brandArea.addEventListener("mousedown", () => { pressTimer = setTimeout(() => openAdmin(), 900); });
    brandArea.addEventListener("mouseup", () => { clearTimeout(pressTimer); });
    brandArea.addEventListener("mouseleave", () => { clearTimeout(pressTimer); });

    adminLoginBtn.addEventListener("click", () => {
      const v = (adminPinInput.value || "").trim();
      if (v !== ADMIN_PIN) { toast("PIN خطأ.", "bad"); return; }
      isAdmin = true;
      closeAdmin();
      applyModeUI();
      toast("تم فتح وضع الإدارة.", "good");
    });

    adminCancelBtn.addEventListener("click", () => closeAdmin());

    adminLogoutBtn.addEventListener("click", () => {
      isAdmin = false;
      applyModeUI();
      toast("تم الخروج من الإدارة.", "warn");
    });

    // =============================
    // Map setup
    // =============================
    const IMG_W = 474;
    const IMG_H = 397;

    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      zoomControl: true,
      attributionControl: false
    });

    const bounds = [[0, 0], [IMG_H, IMG_W]];
    L.imageOverlay('floor1.png', bounds).addTo(map);
    map.fitBounds(bounds);

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function snap(v){ return Math.round(v / SNAP_GRID) * SNAP_GRID; }

    function snapToMap(x, y){
      // x = lng (0..IMG_W), y = lat (0..IMG_H) في CRS.Simple
      let sx = snap(x);
      let sy = snap(y);
      sx = clamp(sx, MAP_MARGIN, IMG_W - MAP_MARGIN);
      sy = clamp(sy, MAP_MARGIN, IMG_H - MAP_MARGIN);
      return { x: sx, y: sy };
    }

    window.addEventListener("orientationchange", () => setTimeout(() => map.invalidateSize(true), 400));
    window.addEventListener("resize", () => setTimeout(() => map.invalidateSize(true), 250));

    // =============================
    // Markers & Path
    // =============================
    let meMarker = null;
    let itemMarker = null;
    let pathLineOutline = null;
    let pathLine = null;

    // =============================
    // Pick my location
    // =============================
    let pickingMe = false;
    document.getElementById("setMe").addEventListener("click", () => {
      pickingMe = true;
      setStatus("اضغط على الخريطة لتحديد موقعك");
      toast("اضغط على مكانك داخل الخريطة لتحديد نقطة البداية.", "warn");
      showPage("map");
    });

    // =============================
    // Graph (Nodes/Edges)
    // =============================
    let mode = "none";       // none | addNode | addEdge
    let nodes = [];          // {id, x, y, marker}
    let edges = {};          // id -> [{to, w}]
    let selectedForEdge = null;

    function dist(a, b) {
      const dx = a.x - b.x, dy = a.y - b.y;
      return Math.sqrt(dx*dx + dy*dy);
    }

    function addEdgeBidirectional(aId, bId, draw = true) {
      const a = nodes.find(n => n.id === aId);
      const b = nodes.find(n => n.id === bId);
      if (!a || !b) return;

      const w = dist(a, b);
      edges[aId] = edges[aId] || [];
      edges[bId] = edges[bId] || [];

      const existsAB = edges[aId].some(e => e.to === bId);
      const existsBA = edges[bId].some(e => e.to === aId);
      if (!existsAB) edges[aId].push({ to: bId, w });
      if (!existsBA) edges[bId].push({ to: aId, w });

      if (draw) L.polyline([[a.y, a.x], [b.y, b.x]], {
        color: "#9e9e9e", weight: 3, opacity: 0.6
      }).addTo(map);
    }

    function nearestNode(x, y) {
      let best = null, bestD = Infinity;
      for (const n of nodes) {
        const d = Math.hypot(n.x - x, n.y - y);
        if (d < bestD) { bestD = d; best = n; }
      }
      return best;
    }

    function dijkstra(startId, endId) {
      const Q = new Set(nodes.map(n => n.id));
      const distMap = {};
      const prev = {};
      for (const n of nodes) distMap[n.id] = Infinity;
      distMap[startId] = 0;

      while (Q.size) {
        let u = null, best = Infinity;
        for (const id of Q) {
          if (distMap[id] < best) { best = distMap[id]; u = id; }
        }
        if (u === null) break;
        Q.delete(u);
        if (u === endId) break;

        for (const e of (edges[u] || [])) {
          if (!Q.has(e.to)) continue;
          const alt = distMap[u] + e.w;
          if (alt < distMap[e.to]) {
            distMap[e.to] = alt;
            prev[e.to] = u;
          }
        }
      }

      const path = [];
      let cur = endId;
      while (cur !== undefined) {
        path.push(cur);
        if (cur === startId) break;
        cur = prev[cur];
      }
      path.reverse();
      return (path[0] === startId) ? path : [];
    }

    function saveGraphToLocalStorage() {
      const payload = { nodes: nodes.map(n => ({ id: n.id, x: n.x, y: n.y })), edges };
      localStorage.setItem("indoor_graph_v2", JSON.stringify(payload));
    }
    function clearGraphLocal() { localStorage.removeItem("indoor_graph_v2"); }

    function drawLoadedGraph() {
      for (const n of nodes) {
        const m = L.circleMarker([n.y, n.x], { radius: 6 }).addTo(map)
          .bindPopup(`${n.id}<br>X=${Math.round(n.x)} Y=${Math.round(n.y)}`);
        n.marker = m;
      }
      const drawn = new Set();
      for (const fromId in edges) {
        for (const e of (edges[fromId] || [])) {
          const key = [fromId, e.to].sort().join("-");
          if (drawn.has(key)) continue;
          drawn.add(key);
          const a = nodes.find(n => n.id === fromId);
          const b = nodes.find(n => n.id === e.to);
          if (a && b) L.polyline([[a.y, a.x], [b.y, b.x]], { color:"#9e9e9e", weight:3, opacity:.6 }).addTo(map);
        }
      }
    }

    function loadGraphFromLocalStorage() {
      const raw = localStorage.getItem("indoor_graph_v2");
      if (!raw) return false;
      const payload = JSON.parse(raw);
      nodes = (payload.nodes || []).map(n => ({ ...n, marker: null }));
      edges = payload.edges || {};
      drawLoadedGraph();
      return true;
    }

    document.getElementById("addNode").addEventListener("click", () => {
      if (!isAdmin) return;
      mode = "addNode";
      selectedForEdge = null;
      setBuildMode("وضع الممرات: إضافة نقاط");
      toast("وضع إضافة نقاط: اضغط على الممر لإضافة نقطة.", "warn");
      showPage("map");
    });

    document.getElementById("addEdge").addEventListener("click", () => {
      if (!isAdmin) return;
      mode = "addEdge";
      selectedForEdge = null;
      setBuildMode("وضع الممرات: ربط نقطتين");
      toast("وضع الربط: اضغط نقطة 1 ثم نقطة 2.", "warn");
      showPage("map");
    });

    document.getElementById("stopMode").addEventListener("click", () => {
      if (!isAdmin) return;
      mode = "none";
      selectedForEdge = null;
      setBuildMode("وضع الممرات: متوقف");
      toast("تم إيقاف وضع الممرات.", "good");
    });

    document.getElementById("saveGraph").addEventListener("click", () => {
      if (!isAdmin) return;
      if (nodes.length < 2) { toast("لا يوجد شبكة كافية للحفظ.", "bad"); return; }
      saveGraphToLocalStorage();
      setStatus("تم حفظ الشبكة");
      toast("تم حفظ الشبكة.", "good");
    });

    document.getElementById("loadGraph").addEventListener("click", () => {
      if (!isAdmin) return;
      const ok = loadGraphFromLocalStorage();
      setStatus(ok ? "تم تحميل الشبكة" : "لا توجد شبكة محفوظة");
      toast(ok ? "تم تحميل الشبكة." : "لا يوجد شبكة محفوظة.", ok ? "good" : "warn");
      showPage("map");
      setTimeout(() => map.invalidateSize(true), 250);
    });

    document.getElementById("clearGraph").addEventListener("click", () => {
      if (!isAdmin) return;
      clearGraphLocal();
      setStatus("تم مسح الشبكة المحفوظة");
      toast("تم مسح الشبكة المحفوظة. قم بعمل Refresh لمسح الرسم الحالي.", "warn");
    });

    // =============================
    // Products (Unique by barcode + name)
    // =============================
    let products = []; // { sku, name, price, x, y }
    let pickingProduct = false;
    let pendingProduct = null;

    function normalizeName(n){
      return (n||"").trim().toLowerCase().replace(/\s+/g, " ");
    }
    function normalizeSku(s){
      return (s||"").trim();
    }
    function parsePrice(v){
      const n = Number(String(v||"").replace(",", "."));
      return Number.isFinite(n) && n >= 0 ? n : null;
    }

    function saveProductsToLocalStorage() {
      localStorage.setItem("indoor_products_v2", JSON.stringify(products));
    }
    function loadProductsFromLocalStorage() {
      const raw = localStorage.getItem("indoor_products_v2");
      if (!raw) return false;
      products = JSON.parse(raw) || [];
      return true;
    }
    function clearProductsLocal() { localStorage.removeItem("indoor_products_v2"); }

    function findProductBySkuOrName(q){
      const s = normalizeSku(q).toLowerCase();
      const n = normalizeName(q);
      // أولوية: باركود مطابق
      let p = products.find(x => (x.sku || "").toLowerCase() === s);
      if (p) return p;
      // ثم اسم مطابق/جزئي
      p = products.find(x => normalizeName(x.name) === n);
      if (p) return p;
      // جزئي
      p = products.find(x => normalizeName(x.name).includes(n) && n.length >= 2);
      return p || null;
    }

    function addOrUpdateProductStrict({sku, name, price, x, y}){
      const skuN = normalizeSku(sku);
      const nameN = normalizeName(name);

      // ممنوع فارغ
      if (!skuN) return { ok:false, msg:"الباركود إجباري." };
      if (!nameN) return { ok:false, msg:"اسم المنتج إجباري." };
      if (price === null) return { ok:false, msg:"سعر المنتج غير صحيح." };

      // تحقق تكرار الاسم والباركود (مع السماح بالتحديث على نفس الباركود)
      const bySku = products.find(p => normalizeSku(p.sku) === skuN);
      const byName = products.find(p => normalizeName(p.name) === nameN);

      if (bySku && byName && bySku !== byName) {
        return { ok:false, msg:"هناك تعارض: هذا الاسم مرتبط بباركود آخر." };
      }

      if (!bySku && byName && !ALLOW_NAME_DUPLICATE) {
        return { ok:false, msg:"اسم المنتج موجود مسبقًا. غيّر الاسم أو حدّث المنتج الصحيح." };
      }

      if (bySku) {
        // تحديث
        bySku.name = name;
        bySku.price = price;
        bySku.x = x;
        bySku.y = y;
        return { ok:true, msg:"تم تحديث المنتج." };
      } else {
        // إضافة
        products.push({ sku: skuN, name, price, x, y });
        return { ok:true, msg:"تم إضافة المنتج." };
      }
    }

    document.getElementById("addProduct").addEventListener("click", () => {
      if (!isAdmin) return;
      const sku = document.getElementById("sku").value.trim();
      const name = document.getElementById("pname").value.trim();
      const price = parsePrice(document.getElementById("pprice").value);

      if (!sku || !name || price === null) { toast("تأكد من إدخال (باركود + اسم + سعر).", "bad"); return; }

      pendingProduct = { sku, name, price };
      pickingProduct = true;
      setStatus("إضافة/تحديث منتج: اضغط على الخريطة لتحديد مكان المنتج");
      toast("اضغط على مكان المنتج على الخريطة لحفظه.", "warn");
      showPage("map");
    });

    document.getElementById("saveProducts").addEventListener("click", () => {
      if (!isAdmin) return;
      saveProductsToLocalStorage();
      setStatus("تم حفظ المنتجات");
      toast("تم حفظ المنتجات.", "good");
    });

    document.getElementById("loadProducts").addEventListener("click", () => {
      if (!isAdmin) return;
      const ok = loadProductsFromLocalStorage();
      setStatus(ok ? "تم تحميل المنتجات" : "لا توجد منتجات محفوظة");
      toast(ok ? "تم تحميل المنتجات." : "لا يوجد منتجات محفوظة.", ok ? "good" : "warn");
    });

    document.getElementById("clearProducts").addEventListener("click", () => {
      if (!isAdmin) return;
      clearProductsLocal();
      products = [];
      setStatus("تم مسح المنتجات");
      toast("تم مسح المنتجات.", "warn");
    });

    // =============================
    // Map click
    // =============================
    map.on('click', (e) => {
      let y = e.latlng.lat;
      let x = e.latlng.lng;

      // Snap داخل الخريطة (خصوصًا للإدارة)
      const snapped = snapToMap(x, y);
      x = snapped.x; y = snapped.y;

      if (pickingMe) {
        pickingMe = false;
        if (meMarker) map.removeLayer(meMarker);
        meMarker = L.marker([y, x]).addTo(map)
          .bindPopup(`موقعي<br>X=${Math.round(x)} Y=${Math.round(y)}`)
          .openPopup();
        setStatus("تم تحديد موقعك");
        toast("تم تحديد موقعك.", "good");
        return;
      }

      if (isAdmin && pickingProduct && pendingProduct) {
        pickingProduct = false;

        const res = addOrUpdateProductStrict({ ...pendingProduct, x, y });
        if (!res.ok) {
          toast(res.msg, "bad");
          pendingProduct = null;
          return;
        }

        saveProductsToLocalStorage();

        L.marker([y, x]).addTo(map).bindPopup(
          `تم الحفظ<br>Barcode: ${pendingProduct.sku}<br>اسم: ${pendingProduct.name}<br>سعر: ${pendingProduct.price}`
        ).openPopup();

        pendingProduct = null;
        document.getElementById("sku").value = "";
        document.getElementById("pname").value = "";
        document.getElementById("pprice").value = "";
        setStatus("تم حفظ المنتج على الخريطة");
        toast(res.msg, "good");
        return;
      }

      if (isAdmin && mode === "addNode") {
        const id = "N" + (nodes.length + 1);
        const m = L.circleMarker([y, x], { radius: 6 }).addTo(map)
          .bindPopup(`${id}<br>X=${Math.round(x)} Y=${Math.round(y)}`);
        nodes.push({ id, x, y, marker: m });
        setStatus("تم إضافة نقطة ممر");
        toast("تم إضافة نقطة.", "good");
        return;
      }

      if (isAdmin && mode === "addEdge") {
        const n = nearestNode(x, y);
        if (!n) { toast("لا يوجد نقاط بعد.", "bad"); return; }

        if (!selectedForEdge) {
          selectedForEdge = n;
          n.marker.openPopup();
          setStatus("اختر النقطة الثانية للربط");
          toast("اختر النقطة الثانية.", "warn");
        } else {
          if (selectedForEdge.id === n.id) return;
          addEdgeBidirectional(selectedForEdge.id, n.id, true);
          selectedForEdge = null;
          setStatus("تم ربط نقطتين");
          toast("تم الربط.", "good");
        }
      }
    });

    // =============================
    // Search & Navigate (by name or barcode)
    // =============================
    function navigateToQuery(raw){
      const q = (raw || "").trim();
      if (!q) { toast("اكتب اسم أو باركود للبحث.", "warn"); return; }

      const item = findProductBySkuOrName(q);
      if (!item) { toast("المنتج غير موجود. اطلب من الإدارة إضافته.", "bad"); return; }

      if (!meMarker) { toast("حدد موقعك أولاً.", "warn"); return; }
      if (nodes.length < 2) { toast("شبكة الممرات غير جاهزة. اطلب من الإدارة تحميلها.", "bad"); return; }

      if (itemMarker) map.removeLayer(itemMarker);
      itemMarker = L.marker([item.y, item.x]).addTo(map)
        .bindPopup(`المنتج<br>${item.name}<br>Barcode: ${item.sku}<br>سعر: ${item.price}`)
        .openPopup();

      const mePos = meMarker.getLatLng();
      const startNode = nearestNode(mePos.lng, mePos.lat);
      const endNode = nearestNode(item.x, item.y);

      if (!startNode || !endNode) { toast("لا توجد نقاط ممر قريبة.", "bad"); return; }

      const pathIds = dijkstra(startNode.id, endNode.id);
      if (!pathIds.length) { toast("لا يوجد مسار. الشبكة تحتاج ربط.", "bad"); return; }

      const pathLatLngs = pathIds.map(id => {
        const n = nodes.find(nn => nn.id === id);
        return [n.y, n.x];
      });
      pathLatLngs.push([item.y, item.x]);

      if (pathLineOutline) map.removeLayer(pathLineOutline);
      if (pathLine) map.removeLayer(pathLine);

      pathLineOutline = L.polyline(pathLatLngs, {
        color: "#000000", weight: 12, opacity: 0.5, lineJoin: "round", lineCap: "round"
      }).addTo(map);

      pathLine = L.polyline(pathLatLngs, {
        color: "#00c853", weight: 8, opacity: 0.95, lineJoin: "round", lineCap: "round"
      }).addTo(map);

      const group = L.featureGroup([meMarker, itemMarker, pathLineOutline, pathLine]);
      map.fitBounds(group.getBounds().pad(0.2));

      setStatus("تم رسم أقصر مسار إلى المنتج");
      toast("تم رسم المسار إلى: " + item.name, "good");
      showPage("map");
    }

    document.getElementById("go").addEventListener("click", () => {
      navigateToQuery(document.getElementById("q").value);
    });

    // =============================
    // Invoice (Bill)
    // =============================
    // bill = { sku: { sku, name, price, qty } }
    let bill = {};

    function billAddBySku(sku){
      const p = products.find(x => (x.sku||"").toLowerCase() === String(sku||"").toLowerCase());
      if (!p) { toast("هذا الباركود غير مسجّل. اطلب من الإدارة إضافته.", "bad"); return; }

      const key = p.sku;
      if (!bill[key]) bill[key] = { sku: p.sku, name: p.name, price: Number(p.price)||0, qty: 0 };
      bill[key].qty += 1;

      toast(`تمت إضافة: ${p.name} (الكمية: ${bill[key].qty})`, "good");
      renderBill();
    }

    function billTotal(){
      let total = 0;
      Object.values(bill).forEach(i => total += (i.price * i.qty));
      return total;
    }

    function renderBill(){
      const tbody = document.querySelector("#billTable tbody");
      tbody.innerHTML = "";

      const items = Object.values(bill);
      items.forEach(item => {
        const tr = document.createElement("tr");
        const line = (item.price * item.qty);

        tr.innerHTML = `
          <td>${item.name}<br><span style="color:rgba(169,182,212,.85); font-size:12px;">${item.sku}</span></td>
          <td>${item.price}</td>
          <td>${item.qty}</td>
          <td>${line.toFixed(2)}</td>
          <td>
            <div class="qtyBtns">
              <button class="btn mini" data-act="minus" data-sku="${item.sku}">-</button>
              <button class="btn mini" data-act="plus" data-sku="${item.sku}">+</button>
              <button class="btn mini danger" data-act="del" data-sku="${item.sku}">حذف</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("billCount").textContent = "عدد الأصناف: " + items.length;
      document.getElementById("billTotal").textContent = "المجموع: " + billTotal().toFixed(2);
    }

    document.getElementById("clearBill").addEventListener("click", () => {
      bill = {};
      toast("تم تفريغ الفاتورة.", "warn");
      renderBill();
    });

    document.getElementById("payCash").addEventListener("click", () => {
      const t = billTotal();
      if (t <= 0) { toast("الفاتورة فارغة.", "warn"); return; }
      toast("تم الدفع نقدًا (محاكاة). الإجمالي: " + t.toFixed(2), "good");
    });

    document.getElementById("payCard").addEventListener("click", () => {
      const t = billTotal();
      if (t <= 0) { toast("الفاتورة فارغة.", "warn"); return; }
      toast("تم الدفع بالبطاقة (محاكاة). الإجمالي: " + t.toFixed(2), "good");
    });

    document.getElementById("billTable").addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const act = btn.getAttribute("data-act");
      const sku = btn.getAttribute("data-sku");
      if (!act || !sku) return;

      if (!bill[sku]) return;
      if (act === "plus") bill[sku].qty += 1;
      if (act === "minus") bill[sku].qty = Math.max(1, bill[sku].qty - 1);
      if (act === "del") delete bill[sku];

      renderBill();
    });

    // =============================
    // Camera Scanner (Better)
    // =============================
    const scanResult = document.getElementById("scanResult");
    const startScanBtn = document.getElementById("startScan");
    const stopScanBtn = document.getElementById("stopScan");
    const useManualBtn = document.getElementById("useManual");

    let scanner = null;
    let scanning = false;

    let scanMode = "normal"; // normal adds to bill + set search | adminAdd sets admin sku

    function setScanText(msg){ scanResult.textContent = msg; }

    async function pickBackCameraId(){
      try{
        const devices = await Html5Qrcode.getCameras();
        if (!devices || !devices.length) return null;
        const preferred = devices.find(d => /back|rear|environment/i.test(d.label));
        return (preferred ? preferred.id : devices[devices.length - 1].id);
      } catch {
        return null;
      }
    }

    function barcodeFormatsOnly(){
      // ملاحظة: بعض الأنواع قد لا تعمل على iOS حسب الدعم
      return [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.ITF,
        Html5QrcodeSupportedFormats.CODABAR,
        Html5QrcodeSupportedFormats.CODE_93
      ];
    }

    function looksLikeBarcode(text){
      const t = String(text||"").trim();
      if (!t) return false;

      // قبول EAN/UPC الشائع
      if (/^\d{8}$/.test(t)) return true;
      if (/^\d{12}$/.test(t)) return true;
      if (/^\d{13}$/.test(t)) return true;
      if (/^\d{14}$/.test(t)) return true;

      // لبعض Code128/39: نص قصير بدون مسافات وروابط
      if (/^https?:\/\//i.test(t)) return false;
      if (/[ \t]/.test(t)) return false;
      if (t.length >= 4 && t.length <= 32 && /^[A-Za-z0-9\-\._]+$/.test(t)) return true;

      return false;
    }

    async function startScanner(){
      if (scanning) return;
      scanning = true;

      try{
        if (!scanner) scanner = new Html5Qrcode("reader");

        setScanText("جارٍ تشغيل الكاميرا...");
        setStatus("تشغيل الكاميرا...");

        const camId = await pickBackCameraId();

        await scanner.start(
          camId ? { deviceId: { exact: camId } } : { facingMode: "environment" },
          {
            fps: 20,
            qrbox: (vw, vh) => {
              const width = Math.floor(Math.min(vw * 0.90, 440));
              const height = Math.floor(Math.min(vh * 0.38, 220));
              return { width, height };
            },
            formatsToSupport: barcodeFormatsOnly(),
            rememberLastUsedCamera: true,
            showTorchButtonIfSupported: true,
            showZoomSliderIfSupported: true,
            defaultZoomValueIfSupported: 2
          },
          async (decodedText) => {
            const code = String(decodedText||"").trim();
            if (!scanning) return;
            if (!looksLikeBarcode(code)) return;

            setScanText("تمت القراءة: " + code);

            // Admin add/update product: ضع الباركود في حقول الإدارة
            if (isAdmin && scanMode === "adminAdd") {
              document.getElementById("sku").value = code;
              toast("تم التقاط الباركود للإدارة. أدخل الاسم والسعر ثم اضغط إضافة/تحديث.", "good");
              scanMode = "normal";
              return;
            }

            // Normal: 1) ضع في البحث 2) أضف للفواتير
            document.getElementById("q").value = code;
            billAddBySku(code);          // إشعار بالكمية + إضافة للفاتورة
          },
          () => {}
        );

        overlayOn();
        setScanText("الكاميرا جاهزة. حسّن الإضاءة وثبّت الهاتف.");
        setStatus("الكاميرا تعمل");
      } catch (err){
        scanning = false;
        overlayOff();
        setScanText("تعذر تشغيل الكاميرا. تأكد من HTTPS ومن إذن الكاميرا.");
        setStatus("فشل تشغيل الكاميرا");
        toast("تعذر تشغيل الكاميرا. تحقق من HTTPS وإذن الكاميرا.", "bad");
        console.error(err);
      }
    }

    async function stopScanner(silent=false){
      if (!scanner) { scanning = false; overlayOff(); return; }
      try{
        if (scanner.isScanning) await scanner.stop();
        await scanner.clear();
      } catch(e){
        // ignore
      } finally {
        scanning = false;
        overlayOff();
        if (!silent){
          setScanText("تم إيقاف الكاميرا.");
          setStatus("تم إيقاف الكاميرا");
        }
      }
    }

    startScanBtn.addEventListener("click", () => { scanMode = "normal"; startScanner(); });
    stopScanBtn.addEventListener("click", () => stopScanner(false));

    useManualBtn.addEventListener("click", () => {
      const val = (prompt("أدخل Barcode أو اسم المنتج يدويًا:") || "").trim();
      if (!val) return;

      // إذا هو باركود: أضف للفاتورة وأيضا للبحث
      const p = findProductBySkuOrName(val);
      if (p) {
        document.getElementById("q").value = p.sku;
        billAddBySku(p.sku);
        toast("تمت الإضافة يدويًا: " + p.name, "good");
      } else {
        toast("غير موجود.", "bad");
      }
    });

    // Admin scan button
    scanToAddBtn.addEventListener("click", () => {
      if (!isAdmin) return;
      scanMode = "adminAdd";
      showPage("scan");
      toast("امسح الباركود للإدارة، ثم أدخل الاسم والسعر، ثم اضغط إضافة/تحديث وحدد المكان بالخريطة.", "warn");
      startScanner();
    });

    // =============================
    // Auto-load
    // =============================
    loadGraphFromLocalStorage();
    loadProductsFromLocalStorage();
    applyModeUI();
    setStatus("جاهز");
    renderBill();

    // Login gate
    loggedIn = localStorage.getItem("logged_in_v1") === "1";
    if (!loggedIn) openLogin();

    setTimeout(() => map.invalidateSize(true), 300);
    setTimeout(() => map.invalidateSize(true), 900);

    // For demo: allow navigation even if login closed by skip
    // (No alerts are used; only toasts)
  </script>
</body>
</html>
