<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Indoor Map + Barcode + Cart + Invoice</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --text:#e8eefc;
      --muted:#a9b6d4;
      --line:#223457;
      --primary:#2f6bff;
      --success:#00c853;
      --danger:#ff4d4f;
      --warning:#ffb020;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, rgba(47,107,255,.25), transparent 55%),
                  radial-gradient(900px 500px at 20% 0%, rgba(0,200,83,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
      -webkit-text-size-adjust: 100%;
    }

    .app{
      min-height: 100vh;
      min-height: 100dvh;
      display:flex;
      flex-direction:column;
      gap: 12px;
      padding: 12px;
    }

    .controls{
      background: linear-gradient(180deg, rgba(17,31,59,.95), rgba(15,27,51,.95));
      border: 1px solid rgba(34,52,87,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .brand{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(11,18,32,.45);
      border: 1px solid rgba(34,52,87,.7);
      margin-bottom: 10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor: default;
    }
    .brand h1{ margin:0; font-size: 15px; line-height: 1.4; }
    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(47,107,255,.18);
      border: 1px solid rgba(47,107,255,.35);
      color: var(--text);
      white-space:nowrap;
      margin-top: 2px;
    }

    .nav{
      display:flex;
      gap: 10px;
      margin: 10px 0 10px;
    }
    .tab{
      flex:1;
      border: 1px solid rgba(34,52,87,.9);
      background: rgba(11,18,32,.4);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(47,107,255,.35), rgba(47,107,255,.12));
      border-color: rgba(47,107,255,.55);
    }

    .section{
      background: rgba(11,18,32,.35);
      border: 1px solid rgba(34,52,87,.75);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .section h2{ margin:0 0 10px; font-size: 14px; }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; }

    .field{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    label{ font-size: 12px; color: var(--muted); }

    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,52,87,.95);
      background: rgba(11,18,32,.55);
      color: var(--text);
      outline:none;
      font-size: 16px;
    }
    input::placeholder{ color: rgba(169,182,212,.7); }

    .btn{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,52,87,.95);
      background: rgba(11,18,32,.45);
      color: var(--text);
      cursor:pointer;
      transition:.15s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{ background: linear-gradient(180deg, rgba(47,107,255,.95), rgba(31,79,209,.92)); border-color: rgba(47,107,255,.7); }
    .btn.success{ background: linear-gradient(180deg, rgba(0,200,83,.9), rgba(0,150,62,.9)); border-color: rgba(0,200,83,.55); }
    .btn.danger{ background: linear-gradient(180deg, rgba(255,77,79,.9), rgba(200,40,42,.9)); border-color: rgba(255,77,79,.55); }
    .btn.warning{ background: linear-gradient(180deg, rgba(255,176,32,.92), rgba(200,130,20,.92)); border-color: rgba(255,176,32,.55); color:#0b1220; font-weight:700; }
    .mini{ width:auto; padding: 10px 10px; font-size: 13px; }
    .hint{ font-size: 12px; color: var(--muted); line-height: 1.6; margin: 6px 0 0; }
    .divider{ border:0; border-top: 1px solid rgba(34,52,87,.75); margin: 10px 0; }

    .main{
      flex:1;
      background: linear-gradient(180deg, rgba(17,31,59,.55), rgba(15,27,51,.35));
      border: 1px solid rgba(34,52,87,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(34,52,87,.85);
      background: rgba(11,18,32,.35);
      gap: 8px;
      flex-wrap:wrap;
    }
    .badge{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(11,18,32,.55);
      border: 1px solid rgba(34,52,87,.9);
      color: var(--text);
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .content{
      padding: 12px;
      min-height: 0;
      flex:1;
      position: relative;
    }

    .page{
      display:block;
      height:100%;
      opacity:0;
      pointer-events:none;
      position:absolute;
      inset:0;
    }
    .page.active{
      opacity:1;
      pointer-events:auto;
      position:relative;
    }

    #map{
      height: 60vh;
      height: 60dvh;
      min-height: 420px;
      border-radius: 14px;
      border: 1px solid rgba(34,52,87,.85);
      overflow:hidden;
      background: rgba(11,18,32,.25);
      touch-action: manipulation;
    }

    .card{
      background: rgba(11,18,32,.35);
      border: 1px solid rgba(34,52,87,.85);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .scanResult{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,52,87,.85);
      background: rgba(11,18,32,.45);
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
    }

    .scanArea{ position: relative; width: 100%; max-width: 560px; margin: 0 auto; }
    #reader{ width: 100%; max-width: 560px; margin: 0 auto; }

    .scanOverlay{
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: grid;
      place-items: center;
      opacity: 0;
      transition: .2s;
    }
    .scanOverlay.on{ opacity: 1; }

    .scanFrame{
      width: min(88%, 420px);
      height: min(35%, 200px);
      border: 2px solid rgba(255,255,255,0.65);
      border-radius: 14px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.12);
    }
    .laser{
      width: calc(min(88%, 420px) - 16px);
      height: 3px;
      border-radius: 999px;
      background: rgba(255, 0, 0, 0.88);
      box-shadow: 0 0 12px rgba(255,0,0,0.75);
      position: absolute;
      transform: translateY(calc(-0.5 * min(35%, 200px) + 8px));
      animation: laserMove 1.6s linear infinite;
    }
    @keyframes laserMove{
      0%   { transform: translateY(calc(-0.5 * min(35%, 200px) + 8px)); }
      50%  { transform: translateY(calc( 0.5 * min(35%, 200px) - 8px)); }
      100% { transform: translateY(calc(-0.5 * min(35%, 200px) + 8px)); }
    }

    /* Modal */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9998;
    }
    .modalBack.on{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: rgba(15,27,51,.98);
      border: 1px solid rgba(34,52,87,.85);
      box-shadow: var(--shadow);
      border-radius: 16px;
      padding: 14px;
    }
    .modal h3{ margin:0 0 10px; font-size: 16px; }
    .modal p{ margin:0 0 10px; color: var(--muted); font-size: 13px; line-height: 1.6; }

    /* Invoice table */
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border: 1px solid rgba(34,52,87,.75);
    }
    .table th, .table td{
      padding: 10px;
      border-bottom: 1px solid rgba(34,52,87,.55);
      font-size: 13px;
      text-align: right;
      vertical-align: middle;
    }
    .table th{ color: var(--muted); font-weight:700; background: rgba(11,18,32,.35); }
    .table tr:last-child td{ border-bottom: none; }
    .qtyBtns{ display:flex; gap: 8px; justify-content:flex-start; flex-wrap:wrap; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34,52,87,.75);
      background: rgba(11,18,32,.45);
      font-size: 12px;
    }

    @media (min-width: 981px){
      .app{
        display:grid;
        grid-template-columns: 360px 1fr;
        gap: 16px;
        padding: 16px;
        min-height: 100vh;
        min-height: 100dvh;
      }
      .controls{
        position: sticky;
        top: 16px;
        height: calc(100vh - 32px);
        overflow:auto;
      }
      #map{
        height: calc(100vh - 32px - 56px - 24px);
        min-height: 560px;
      }
    }
  </style>
</head>

<body>
  <!-- Login Modal (Demo OTP) -->
  <div class="modalBack" id="loginModal">
    <div class="modal">
      <h3>تسجيل دخول</h3>
      <p>نسخة تجريبية: الكود يظهر داخل الصفحة بدل SMS (الـ SMS الحقيقي يحتاج Backend).</p>

      <div class="field">
        <label>رقم الهاتف</label>
        <input id="phone" placeholder="مثال: 0591234567" inputmode="tel" />
      </div>

      <div class="row">
        <button class="btn primary" id="sendOtp" type="button">إرسال الكود</button>
        <button class="btn" id="skipLogin" type="button">دخول تجريبي</button>
      </div>

      <div id="otpBox" style="display:none; margin-top:12px;">
        <div class="field">
          <label>أدخل الكود</label>
          <input id="otp" placeholder="000000" inputmode="numeric" />
        </div>
        <div class="row">
          <button class="btn success" id="verifyOtp" type="button">تحقق</button>
        </div>
        <p class="hint" id="otpHint"></p>
      </div>
    </div>
  </div>

  <!-- Admin PIN Modal -->
  <div class="modalBack" id="adminModal">
    <div class="modal">
      <h3>دخول الإدارة</h3>
      <p>للوصول للإدارة: اضغط مطولاً على العنوان ثم أدخل PIN.</p>
      <div class="field">
        <label>Admin PIN</label>
        <input id="adminPin" placeholder="****" inputmode="numeric" />
      </div>
      <div class="row">
        <button class="btn success" id="adminLogin" type="button">دخول</button>
        <button class="btn" id="adminCancel" type="button">إلغاء</button>
      </div>
      <p class="hint">لتغيير الـ PIN عدّل المتغير <code>ADMIN_PIN</code>.</p>
    </div>
  </div>

  <!-- Add To Cart Modal -->
  <div class="modalBack" id="cartModal">
    <div class="modal">
      <h3>إضافة إلى العربة</h3>
      <p id="cartInfo" style="margin:0 0 12px; color: var(--muted); font-size:13px;"></p>

      <div class="row" style="margin-bottom:10px;">
        <span class="chip" id="cartSku">Barcode: -</span>
        <span class="chip" id="cartPrice">السعر: -</span>
      </div>

      <div class="row" style="align-items:center; margin-bottom: 10px;">
        <span class="chip">الكمية</span>
        <button class="btn mini" id="qtyMinus" type="button">-</button>
        <span class="chip" id="qtyVal" style="min-width: 52px; justify-content:center;">1</span>
        <button class="btn mini" id="qtyPlus" type="button">+</button>
      </div>

      <div class="row">
        <button class="btn success" id="addToCartBtn" type="button">إضافة إلى العربة</button>
        <button class="btn" id="cartCancelBtn" type="button">إلغاء</button>
      </div>

      <hr class="divider">
      <div class="row">
        <button class="btn primary" id="viewOnMapBtn" type="button">عرض على الخريطة (مسار)</button>
      </div>

      <p class="hint">بعد الإضافة سيتم نقلك تلقائيًا إلى صفحة الفاتورة.</p>
    </div>
  </div>

  <div class="app">
    <!-- CONTROLS -->
    <aside class="controls">
      <div class="brand" id="brandArea" title="اضغط مطولاً للدخول للإدارة">
        <div>
          <h1>نظام خريطة متجر + باركود + عربة + فاتورة</h1>
          <div class="hint">بحث/مسح ➜ تحديد كمية ➜ إضافة للعربة ➜ فاتورة</div>
        </div>
        <span class="pill" id="modeBadge">الوضع: مستخدم</span>
      </div>

      <div class="nav">
        <button class="tab active" id="tabMap" type="button">الخريطة</button>
        <button class="tab" id="tabScan" type="button">الكاميرا</button>
        <button class="tab" id="tabBill" type="button">الفاتورة</button>
      </div>

      <!-- USER SEARCH (يختفي في صفحة الفاتورة) -->
      <div class="section" id="userSearchSection">
        <h2>بحث المستخدم</h2>

        <div class="field">
          <label>بحث بالاسم أو الباركود</label>
          <input id="q" placeholder="مثال: حليب أو 629100..." />
        </div>

        <div class="row">
          <button class="btn primary" id="go" type="button">بحث</button>
          <button class="btn" id="setMe" type="button">حدد موقعي (اضغط على الخريطة)</button>
        </div>

        <p class="hint">البحث لا يضيف مباشرة. سيفتح نافذة لإضافة للعربة مع الكمية.</p>
      </div>

      <!-- ADMIN PRODUCTS (Hidden by default) -->
      <div class="section admin-only" style="display:none;">
        <h2>إدارة المنتجات (ممنوع التكرار)</h2>

        <div class="field">
          <label>Barcode (إجباري)</label>
          <input id="sku" placeholder="629100..." inputmode="numeric" />
        </div>

        <div class="field">
          <label>اسم المنتج (إجباري)</label>
          <input id="pname" placeholder="مثال: حليب" />
        </div>

        <div class="field">
          <label>سعر المنتج (إجباري)</label>
          <input id="pprice" placeholder="مثال: 7.5" inputmode="decimal" />
        </div>

        <div class="row">
          <button class="btn success" id="addProduct" type="button">إضافة منتج (اضغط على الخريطة)</button>
          <button class="btn primary" id="adminFind" type="button">بحث (اسم/باركود)</button>
        </div>

        <hr class="divider">

        <div class="row">
          <button class="btn mini success" id="saveProducts" type="button">حفظ المنتجات</button>
          <button class="btn mini" id="loadProducts" type="button">تحميل المنتجات</button>
          <button class="btn mini danger" id="clearProducts" type="button">مسح المنتجات</button>
        </div>

        <hr class="divider">

        <h2 style="margin:0 0 10px; font-size:14px;">حذف منتج</h2>
        <div class="field">
          <label>حذف بالاسم أو بالباركود</label>
          <input id="delQuery" placeholder="مثال: حليب أو 629100..." />
        </div>
        <div class="row">
          <button class="btn danger" id="deleteProductBtn" type="button">حذف المنتج</button>
        </div>

        <p class="hint">أي مشكلة أو رفض يظهر في شريط الحالة العلوي فقط.</p>
      </div>

      <div class="section admin-only" style="display:none;">
        <h2>إدارة</h2>
        <div class="row">
          <button class="btn danger" id="adminLogout" type="button">خروج من الإدارة</button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="badge" id="statusText">جاهز</div>
        <div class="badge" id="buildModeText">وضع الممرات: متوقف</div>
      </div>

      <div class="content">
        <!-- MAP PAGE -->
        <section class="page active" id="pageMap">
          <!-- Admin: Graph tools قريب من الخريطة -->
          <div class="card admin-only" style="display:none; margin-bottom:10px;">
            <h2 style="margin:0 0 10px; font-size:16px;">إدارة شبكة الممرات</h2>

            <div class="row">
              <button class="btn mini" id="addNode" type="button">أضف نقطة</button>
              <button class="btn mini" id="addEdge" type="button">اربط نقطتين</button>
              <button class="btn mini danger" id="deleteNode" type="button">حذف نقطة</button>
              <button class="btn mini" id="stopMode" type="button">إيقاف</button>
            </div>

            <hr class="divider">

            <div class="row">
              <button class="btn mini success" id="saveGraph" type="button">حفظ الشبكة</button>
              <button class="btn mini" id="loadGraph" type="button">تحميل الشبكة</button>
              <button class="btn mini danger" id="clearGraph" type="button">مسح الشبكة</button>
            </div>

            <p class="hint">لا توجد تنبيهات منبثقة.</p>
          </div>

          <div id="map"></div>
        </section>

        <!-- SCAN PAGE -->
        <section class="page" id="pageScan">
          <div class="card">
            <h2 style="margin:0 0 10px; font-size:16px;">فحص الباركود بالكاميرا</h2>

            <div class="scanArea">
              <div id="reader"></div>
              <div class="scanOverlay" id="scanOverlay" aria-hidden="true">
                <div class="scanFrame"></div>
                <div class="laser"></div>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="startScan" type="button">تشغيل</button>
              <button class="btn" id="stopScan" type="button">إيقاف</button>
              <button class="btn" id="toggleManual" type="button">إدخال يدوي</button>
              <button class="btn success admin-only" id="scanToAdd" type="button" style="display:none;">
                مسح للإدارة (تعبئة الباركود)
              </button>
            </div>

            <div id="manualBox" style="display:none; margin-top:10px;">
              <div class="field">
                <label>إدخال يدوي (باركود)</label>
                <input id="manualCode" placeholder="629100..." inputmode="numeric" />
              </div>
              <div class="row">
                <button class="btn success" id="manualOpenCart" type="button">فتح العربة لهذا المنتج</button>
                <button class="btn" id="manualSearch" type="button">بحث / فتح العربة</button>
              </div>
              <p class="hint">الإدخال اليدوي يفتح نافذة تحديد الكمية ثم إضافة للعربة.</p>
            </div>

            <p class="hint">في وضع المستخدم: المسح يفتح نافذة تحديد كمية + إضافة للعربة ثم الفاتورة.</p>
          </div>

          <div class="card">
            <h2 style="margin:0 0 10px; font-size:16px;">النتيجة</h2>
            <div class="scanResult" id="scanResult">لا يوجد قراءة بعد.</div>
          </div>
        </section>

        <!-- BILL PAGE -->
        <section class="page" id="pageBill">
          <div class="card">
            <h2 style="margin:0 0 10px; font-size:16px;">الفاتورة</h2>

            <div class="row" style="margin-bottom:10px;">
              <span class="chip" id="billCount">عدد الأصناف: 0</span>
              <span class="chip" id="billTotal">المجموع: 0</span>
            </div>

            <div style="overflow:auto; border-radius:12px;">
              <table class="table" id="billTable">
                <thead>
                  <tr>
                    <th>المنتج</th>
                    <th>السعر</th>
                    <th>الكمية</th>
                    <th>الإجمالي</th>
                    <th>تحكم</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn" id="continueShopping" type="button">متابعة التسوق (كاميرا)</button>
              <button class="btn" id="backToMap" type="button">العودة للخريطة</button>
              <button class="btn danger" id="clearBill" type="button">تفريغ الفاتورة</button>
            </div>

            <hr class="divider">

            <h2 style="margin:0 0 10px; font-size:16px;">الدفع (محاكاة)</h2>
            <div class="row">
              <button class="btn success" id="payCash" type="button">دفع نقدًا</button>
              <button class="btn primary" id="payCard" type="button">دفع بطاقة</button>
            </div>
            <p class="hint">الدفع الحقيقي يحتاج بوابة دفع + سيرفر.</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // =============================
    // Config
    // =============================
    const ADMIN_PIN = "1234"; // غيّرها
    const SNAP_GRID = 6;      // تقارب نقاط الممرات (سناب)
    const MAP_MARGIN = 6;     // هامش داخل الخريطة
    const NEAR_NODE_THRESHOLD = 15; // لحذف نقطة (قربها)

    // =============================
    // Status UI (بدون Alerts/Toasts)
    // =============================
    const statusText = document.getElementById("statusText");
    const buildModeText = document.getElementById("buildModeText");
    function setStatus(msg){ statusText.textContent = msg; }
    function setBuildMode(msg){ buildModeText.textContent = msg; }

    // =============================
    // Pages (Tabs)
    // =============================
    const tabMap = document.getElementById("tabMap");
    const tabScan = document.getElementById("tabScan");
    const tabBill = document.getElementById("tabBill");
    const pageMap = document.getElementById("pageMap");
    const pageScan = document.getElementById("pageScan");
    const pageBill = document.getElementById("pageBill");
    const userSearchSection = document.getElementById("userSearchSection");

    function showPage(name){
      const isMap  = (name === "map");
      const isScan = (name === "scan");
      const isBill = (name === "bill");

      pageMap.classList.toggle("active", isMap);
      pageScan.classList.toggle("active", isScan);
      pageBill.classList.toggle("active", isBill);

      tabMap.classList.toggle("active", isMap);
      tabScan.classList.toggle("active", isScan);
      tabBill.classList.toggle("active", isBill);

      userSearchSection.style.display = isBill ? "none" : "block";

      document.body.offsetHeight;
      location.hash = isMap ? "#map" : isScan ? "#scan" : "#bill";

      if (isMap) {
        setTimeout(() => map.invalidateSize(true), 150);
        setTimeout(() => map.invalidateSize(true), 500);
      }
      if (isBill) renderBill();
    }

    tabMap.addEventListener("click", (e) => { e.preventDefault(); stopScanner(true); showPage("map"); setStatus("صفحة الخريطة"); });
    tabScan.addEventListener("click", (e) => { e.preventDefault(); showPage("scan"); setStatus("صفحة الكاميرا"); });
    tabBill.addEventListener("click", (e) => { e.preventDefault(); stopScanner(true); showPage("bill"); setStatus("صفحة الفاتورة"); });

    window.addEventListener("load", () => {
      if (location.hash === "#scan") showPage("scan");
      else if (location.hash === "#bill") showPage("bill");
      else showPage("map");
    });
    window.addEventListener("hashchange", () => {
      if (location.hash === "#scan") showPage("scan");
      else if (location.hash === "#bill") showPage("bill");
      else showPage("map");
    });

    // =============================
    // Login (Demo OTP)
    // =============================
    const loginModal = document.getElementById("loginModal");
    const phoneInput = document.getElementById("phone");
    const sendOtpBtn = document.getElementById("sendOtp");
    const verifyOtpBtn = document.getElementById("verifyOtp");
    const skipLoginBtn = document.getElementById("skipLogin");
    const otpBox = document.getElementById("otpBox");
    const otpHint = document.getElementById("otpHint");
    const otpInput = document.getElementById("otp");

    let loggedIn = false;
    let otpCode = null;

    function openLogin(){ loginModal.classList.add("on"); }
    function closeLogin(){ loginModal.classList.remove("on"); }
    function normalizePhone(p){ return (p || "").replace(/[^\d]/g, ""); }

    sendOtpBtn.addEventListener("click", () => {
      const p = normalizePhone(phoneInput.value);
      if (p.length < 9) { setStatus("أدخل رقم هاتف صحيح."); return; }
      otpCode = String(Math.floor(100000 + Math.random()*900000));
      otpBox.style.display = "block";
      otpHint.textContent = "كود تجريبي (بدل SMS): " + otpCode;
      setStatus("تم إرسال الكود (تجريبي).");
    });

    verifyOtpBtn.addEventListener("click", () => {
      const v = (otpInput.value || "").trim();
      if (!otpCode) { setStatus("اضغط إرسال الكود أولاً."); return; }
      if (v !== otpCode) { setStatus("الكود غير صحيح."); return; }
      loggedIn = true;
      localStorage.setItem("logged_in_v3", "1");
      closeLogin();
      setStatus("تم تسجيل الدخول.");
    });

    skipLoginBtn.addEventListener("click", () => {
      loggedIn = true;
      localStorage.setItem("logged_in_v3", "1");
      closeLogin();
      setStatus("تم الدخول تجريبيًا.");
    });

    // =============================
    // Admin Hidden Mode (Long press + PIN)
    // =============================
    const adminModal = document.getElementById("adminModal");
    const adminPinInput = document.getElementById("adminPin");
    const adminLoginBtn = document.getElementById("adminLogin");
    const adminCancelBtn = document.getElementById("adminCancel");
    const brandArea = document.getElementById("brandArea");
    const modeBadge = document.getElementById("modeBadge");
    const adminLogoutBtn = document.getElementById("adminLogout");
    const adminEls = document.querySelectorAll(".admin-only");
    const scanToAddBtn = document.getElementById("scanToAdd");

    let isAdmin = false;
    let pressTimer = null;

    function openAdmin(){ adminModal.classList.add("on"); adminPinInput.value = ""; adminPinInput.focus(); }
    function closeAdmin(){ adminModal.classList.remove("on"); }

    function applyModeUI() {
      modeBadge.textContent = isAdmin ? "الوضع: إدارة" : "الوضع: مستخدم";
      adminEls.forEach(el => el.style.display = isAdmin ? "block" : "none");
      if (scanToAddBtn) scanToAddBtn.style.display = isAdmin ? "flex" : "none";

      if (!isAdmin) {
        mode = "none";
        selectedForEdge = null;
        pickingProduct = false;
        pendingProduct = null;
        setBuildMode("وضع الممرات: متوقف");
      }
    }

    brandArea.addEventListener("touchstart", () => { pressTimer = setTimeout(() => openAdmin(), 900); }, {passive:true});
    brandArea.addEventListener("touchend", () => { clearTimeout(pressTimer); }, {passive:true});
    brandArea.addEventListener("mousedown", () => { pressTimer = setTimeout(() => openAdmin(), 900); });
    brandArea.addEventListener("mouseup", () => { clearTimeout(pressTimer); });
    brandArea.addEventListener("mouseleave", () => { clearTimeout(pressTimer); });

    adminLoginBtn.addEventListener("click", () => {
      const v = (adminPinInput.value || "").trim();
      if (v !== ADMIN_PIN) { setStatus("PIN خطأ."); return; }
      isAdmin = true;
      closeAdmin();
      applyModeUI();
      setStatus("تم فتح وضع الإدارة.");
    });

    adminCancelBtn.addEventListener("click", () => closeAdmin());

    adminLogoutBtn.addEventListener("click", () => {
      isAdmin = false;
      applyModeUI();
      setStatus("تم الخروج من الإدارة.");
    });

    // =============================
    // Map setup
    // =============================
    const IMG_W = 474;
    const IMG_H = 397;

    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      zoomControl: true,
      attributionControl: false
    });

    const bounds = [[0, 0], [IMG_H, IMG_W]];
    L.imageOverlay('floor1.png', bounds).addTo(map);
    map.fitBounds(bounds);

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function snap(v){ return Math.round(v / SNAP_GRID) * SNAP_GRID; }
    function snapToMap(x, y){
      let sx = snap(x), sy = snap(y);
      sx = clamp(sx, MAP_MARGIN, IMG_W - MAP_MARGIN);
      sy = clamp(sy, MAP_MARGIN, IMG_H - MAP_MARGIN);
      return { x:sx, y:sy };
    }

    const graphNodeLayer = L.layerGroup().addTo(map);
    const graphEdgeLayer = L.layerGroup().addTo(map);
    const userLayer = L.layerGroup().addTo(map);
    const pathLayer = L.layerGroup().addTo(map);
    const productLayer = L.layerGroup().addTo(map);

    window.addEventListener("orientationchange", () => setTimeout(() => map.invalidateSize(true), 400));
    window.addEventListener("resize", () => setTimeout(() => map.invalidateSize(true), 250));

    // =============================
    // Markers
    // =============================
    let meMarker = null;

    // =============================
    // Pick my location
    // =============================
    let pickingMe = false;
    document.getElementById("setMe").addEventListener("click", () => {
      pickingMe = true;
      setStatus("اضغط على الخريطة لتحديد موقعك");
      showPage("map");
    });

    // =============================
    // Graph (Nodes/Edges) + Delete Node
    // =============================
    let mode = "none";       // none | addNode | addEdge | deleteNode
    let nodes = [];          // {id, x, y, marker}
    let edges = {};          // id -> [{to, w}]
    let selectedForEdge = null;

    function dist(a, b) {
      const dx = a.x - b.x, dy = a.y - b.y;
      return Math.sqrt(dx*dx + dy*dy);
    }

    function redrawGraphLayers(){
      graphNodeLayer.clearLayers();
      graphEdgeLayer.clearLayers();

      for (const n of nodes) {
        const m = L.circleMarker([n.y, n.x], { radius: 6 }).addTo(graphNodeLayer);
        n.marker = m;
      }

      const drawn = new Set();
      for (const fromId in edges) {
        for (const e of (edges[fromId] || [])) {
          const key = [fromId, e.to].sort().join("-");
          if (drawn.has(key)) continue;
          drawn.add(key);
          const a = nodes.find(n => n.id === fromId);
          const b = nodes.find(n => n.id === e.to);
          if (a && b) L.polyline([[a.y, a.x], [b.y, b.x]], { color:"#9e9e9e", weight:3, opacity:.6 }).addTo(graphEdgeLayer);
        }
      }
    }

    function addEdgeBidirectional(aId, bId) {
      const a = nodes.find(n => n.id === aId);
      const b = nodes.find(n => n.id === bId);
      if (!a || !b) return;

      const w = dist(a, b);
      edges[aId] = edges[aId] || [];
      edges[bId] = edges[bId] || [];

      const existsAB = edges[aId].some(e => e.to === bId);
      const existsBA = edges[bId].some(e => e.to === aId);
      if (!existsAB) edges[aId].push({ to: bId, w });
      if (!existsBA) edges[bId].push({ to: aId, w });

      redrawGraphLayers();
    }

    function nearestNode(x, y) {
      let best = null, bestD = Infinity;
      for (const n of nodes) {
        const d = Math.hypot(n.x - x, n.y - y);
        if (d < bestD) { bestD = d; best = n; }
      }
      return { node: best, d: bestD };
    }

    function dijkstra(startId, endId) {
      const Q = new Set(nodes.map(n => n.id));
      const distMap = {};
      const prev = {};
      for (const n of nodes) distMap[n.id] = Infinity;
      distMap[startId] = 0;

      while (Q.size) {
        let u = null, best = Infinity;
        for (const id of Q) {
          if (distMap[id] < best) { best = distMap[id]; u = id; }
        }
        if (u === null) break;
        Q.delete(u);
        if (u === endId) break;

        for (const e of (edges[u] || [])) {
          if (!Q.has(e.to)) continue;
          const alt = distMap[u] + e.w;
          if (alt < distMap[e.to]) {
            distMap[e.to] = alt;
            prev[e.to] = u;
          }
        }
      }

      const path = [];
      let cur = endId;
      while (cur !== undefined) {
        path.push(cur);
        if (cur === startId) break;
        cur = prev[cur];
      }
      path.reverse();
      return (path[0] === startId) ? path : [];
    }

    function saveGraphToLocalStorage() {
      const payload = { nodes: nodes.map(n => ({ id: n.id, x: n.x, y: n.y })), edges };
      localStorage.setItem("indoor_graph_v4", JSON.stringify(payload));
    }
    function clearGraphLocal() { localStorage.removeItem("indoor_graph_v4"); }

    function loadGraphFromLocalStorage() {
      const raw = localStorage.getItem("indoor_graph_v4");
      if (!raw) return false;
      const payload = JSON.parse(raw);
      nodes = (payload.nodes || []).map(n => ({ ...n, marker: null }));
      edges = payload.edges || {};
      redrawGraphLayers();
      return true;
    }

    document.getElementById("addNode").addEventListener("click", () => {
      if (!isAdmin) return;
      mode = "addNode";
      selectedForEdge = null;
      setBuildMode("وضع الممرات: إضافة نقاط");
      setStatus("اضغط على الخريطة لإضافة نقطة");
      showPage("map");
    });

    document.getElementById("addEdge").addEventListener("click", () => {
      if (!isAdmin) return;
      mode = "addEdge";
      selectedForEdge = null;
      setBuildMode("وضع الممرات: ربط نقطتين");
      setStatus("اضغط نقطة 1 ثم نقطة 2");
      showPage("map");
    });

    document.getElementById("deleteNode").addEventListener("click", () => {
      if (!isAdmin) return;
      mode = "deleteNode";
      selectedForEdge = null;
      setBuildMode("وضع الممرات: حذف نقطة");
      setStatus("اضغط قرب النقطة لحذفها");
      showPage("map");
    });

    document.getElementById("stopMode").addEventListener("click", () => {
      if (!isAdmin) return;
      mode = "none";
      selectedForEdge = null;
      setBuildMode("وضع الممرات: متوقف");
      setStatus("تم إيقاف وضع الممرات");
    });

    document.getElementById("saveGraph").addEventListener("click", () => {
      if (!isAdmin) return;
      if (nodes.length < 2) { setStatus("لا يوجد شبكة كافية للحفظ."); return; }
      saveGraphToLocalStorage();
      setStatus("تم حفظ الشبكة");
    });

    document.getElementById("loadGraph").addEventListener("click", () => {
      if (!isAdmin) return;
      const ok = loadGraphFromLocalStorage();
      setStatus(ok ? "تم تحميل الشبكة" : "لا توجد شبكة محفوظة");
      showPage("map");
      setTimeout(() => map.invalidateSize(true), 250);
    });

    document.getElementById("clearGraph").addEventListener("click", () => {
      if (!isAdmin) return;
      clearGraphLocal();
      nodes = [];
      edges = {};
      redrawGraphLayers();
      setStatus("تم مسح الشبكة (محليًا)");
    });

    // =============================
    // Products (No duplicates: SKU + Name) + Delete Product
    // =============================
    let products = []; // { sku, name, price, x, y }
    let pickingProduct = false;
    let pendingProduct = null;

    function normalizeName(n){
      return (n||"").trim().toLowerCase().replace(/\s+/g, " ");
    }
    function normalizeSku(s){
      return (s||"").trim().toLowerCase();
    }
    function parsePrice(v){
      const n = Number(String(v||"").replace(",", "."));
      return Number.isFinite(n) && n >= 0 ? n : null;
    }

    function existsSku(sku){
      const s = normalizeSku(sku);
      return products.some(p => normalizeSku(p.sku) === s);
    }
    function existsName(name){
      const n = normalizeName(name);
      return products.some(p => normalizeName(p.name) === n);
    }

    function saveProductsToLocalStorage() {
      localStorage.setItem("indoor_products_v4", JSON.stringify(products));
    }
    function loadProductsFromLocalStorage() {
      const raw = localStorage.getItem("indoor_products_v4");
      if (!raw) return false;
      products = JSON.parse(raw) || [];
      return true;
    }
    function clearProductsLocal() { localStorage.removeItem("indoor_products_v4"); }

    function findProductBySkuOrName(q){
      const s = normalizeSku(q);
      const n = normalizeName(q);

      let p = products.find(x => normalizeSku(x.sku) === s);
      if (p) return p;

      p = products.find(x => normalizeName(x.name) === n);
      if (p) return p;

      if (n.length >= 2) {
        p = products.find(x => normalizeName(x.name).includes(n));
        if (p) return p;
      }
      return null;
    }

    function addProductStrict({sku, name, price, x, y}){
      const skuN = normalizeSku(sku);
      const nameN = normalizeName(name);

      if (!skuN) return { ok:false, msg:"الباركود إجباري." };
      if (!nameN) return { ok:false, msg:"اسم المنتج إجباري." };
      if (price === null) return { ok:false, msg:"سعر المنتج غير صحيح." };

      if (existsSku(skuN)) return { ok:false, msg:"هذا الباركود موجود مسبقًا. ممنوع التكرار." };
      if (existsName(nameN)) return { ok:false, msg:"اسم المنتج موجود مسبقًا. ممنوع التكرار." };

      products.push({ sku: skuN, name, price, x, y });
      return { ok:true, msg:"تمت إضافة المنتج." };
    }

    document.getElementById("addProduct").addEventListener("click", () => {
      if (!isAdmin) return;

      const sku = document.getElementById("sku").value.trim();
      const name = document.getElementById("pname").value.trim();
      const price = parsePrice(document.getElementById("pprice").value);

      if (!sku || !name || price === null) { setStatus("أدخل (باركود + اسم + سعر) أولاً."); return; }
      if (existsSku(sku)) { setStatus("هذا الباركود موجود مسبقًا. ممنوع التكرار."); return; }
      if (existsName(name)) { setStatus("اسم المنتج موجود مسبقًا. ممنوع التكرار."); return; }

      pendingProduct = { sku, name, price };
      pickingProduct = true;
      setStatus("اضغط على الخريطة لتحديد مكان المنتج");
      showPage("map");
    });

    document.getElementById("adminFind").addEventListener("click", () => {
      if (!isAdmin) return;
      const query = (document.getElementById("sku").value || document.getElementById("pname").value || "").trim();
      if (!query) { setStatus("اكتب اسم أو باركود للبحث."); return; }
      const item = findProductBySkuOrName(query);
      if (!item) { setStatus("المنتج غير موجود."); return; }
      setStatus("تم العثور على: " + item.name + " | السعر: " + Number(item.price).toFixed(2));
      showPage("map");
      productLayer.clearLayers();
      L.marker([item.y, item.x]).addTo(productLayer);
      map.setView([item.y, item.x], map.getZoom());
    });

    document.getElementById("saveProducts").addEventListener("click", () => {
      if (!isAdmin) return;
      saveProductsToLocalStorage();
      setStatus("تم حفظ المنتجات");
    });

    document.getElementById("loadProducts").addEventListener("click", () => {
      if (!isAdmin) return;
      const ok = loadProductsFromLocalStorage();
      setStatus(ok ? "تم تحميل المنتجات" : "لا توجد منتجات محفوظة");
    });

    document.getElementById("clearProducts").addEventListener("click", () => {
      if (!isAdmin) return;
      clearProductsLocal();
      products = [];
      setStatus("تم مسح المنتجات");
    });

    // ===== Admin: Delete Product =====
    const delQueryInput = document.getElementById("delQuery");
    const deleteProductBtn = document.getElementById("deleteProductBtn");

    function deleteProductBySkuOrName(raw) {
      const q = (raw || "").trim();
      if (!q) return { ok:false, msg:"أدخل اسم أو باركود للحذف." };

      const skuN = normalizeSku(q);
      const nameN = normalizeName(q);

      const idx = products.findIndex(p =>
        normalizeSku(p.sku) === skuN ||
        normalizeName(p.name) === nameN
      );

      if (idx < 0) return { ok:false, msg:"العنصر غير موجود، لا يمكن حذفه." };

      const removed = products[idx];
      products.splice(idx, 1);
      saveProductsToLocalStorage();

      // إزالة من الفاتورة إذا موجود
      if (bill && bill[removed.sku]) {
        delete bill[removed.sku];
        renderBill();
      }

      productLayer.clearLayers();
      pathLayer.clearLayers();

      return { ok:true, msg:`تم حذف المنتج: ${removed.name} (Barcode: ${removed.sku})` };
    }

    deleteProductBtn.addEventListener("click", () => {
      if (!isAdmin) return;
      const res = deleteProductBySkuOrName(delQueryInput.value);
      setStatus(res.msg);
      if (res.ok) delQueryInput.value = "";
    });

    // =============================
    // Invoice (Bill)
    // =============================
    let bill = {}; // sku -> {sku,name,price,qty}

    function billTotal(){
      let total = 0;
      Object.values(bill).forEach(i => total += (i.price * i.qty));
      return total;
    }

    function renderBill(){
      const tbody = document.querySelector("#billTable tbody");
      tbody.innerHTML = "";

      const items = Object.values(bill);
      items.forEach(item => {
        const tr = document.createElement("tr");
        const line = (item.price * item.qty);

        tr.innerHTML = `
          <td>${item.name}<br><span style="color:rgba(169,182,212,.85); font-size:12px;">${item.sku}</span></td>
          <td>${Number(item.price).toFixed(2)}</td>
          <td>${item.qty}</td>
          <td>${line.toFixed(2)}</td>
          <td>
            <div class="qtyBtns">
              <button class="btn mini" data-act="minus" data-sku="${item.sku}">-</button>
              <button class="btn mini" data-act="plus" data-sku="${item.sku}">+</button>
              <button class="btn mini danger" data-act="del" data-sku="${item.sku}">حذف</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("billCount").textContent = "عدد الأصناف: " + items.length;
      document.getElementById("billTotal").textContent = "المجموع: " + billTotal().toFixed(2);
    }

    document.getElementById("billTable").addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const act = btn.getAttribute("data-act");
      const sku = btn.getAttribute("data-sku");
      if (!act || !sku) return;

      if (!bill[sku]) return;
      if (act === "plus") bill[sku].qty += 1;
      if (act === "minus") bill[sku].qty = Math.max(1, bill[sku].qty - 1);
      if (act === "del") delete bill[sku];

      renderBill();
      setStatus("تم تحديث الفاتورة.");
    });

    document.getElementById("clearBill").addEventListener("click", () => {
      bill = {};
      renderBill();
      setStatus("تم تفريغ الفاتورة.");
    });

    document.getElementById("payCash").addEventListener("click", () => {
      const t = billTotal();
      if (t <= 0) { setStatus("الفاتورة فارغة."); return; }
      setStatus("تم الدفع نقدًا (محاكاة). الإجمالي: " + t.toFixed(2));
    });

    document.getElementById("payCard").addEventListener("click", () => {
      const t = billTotal();
      if (t <= 0) { setStatus("الفاتورة فارغة."); return; }
      setStatus("تم الدفع بالبطاقة (محاكاة). الإجمالي: " + t.toFixed(2));
    });

    document.getElementById("continueShopping").addEventListener("click", () => {
      showPage("scan");
      setStatus("متابعة التسوق: صفحة الكاميرا");
    });

    document.getElementById("backToMap").addEventListener("click", () => {
      showPage("map");
      setStatus("العودة إلى الخريطة");
    });

    // =============================
    // Add To Cart Modal Logic
    // =============================
    const cartModal = document.getElementById("cartModal");
    const cartInfo  = document.getElementById("cartInfo");
    const cartSku   = document.getElementById("cartSku");
    const cartPrice = document.getElementById("cartPrice");
    const qtyVal    = document.getElementById("qtyVal");

    const qtyMinus  = document.getElementById("qtyMinus");
    const qtyPlus   = document.getElementById("qtyPlus");
    const addToCartBtn = document.getElementById("addToCartBtn");
    const cartCancelBtn = document.getElementById("cartCancelBtn");
    const viewOnMapBtn  = document.getElementById("viewOnMapBtn");

    let selectedProduct = null;
    let selectedQty = 1;

    function openCartModal(product, sourceText){
      selectedProduct = product;
      selectedQty = 1;

      cartInfo.textContent = sourceText || "تم العثور على المنتج. اختر الكمية ثم أضف للعربة.";
      cartSku.textContent = "Barcode: " + product.sku;
      cartPrice.textContent = "السعر: " + Number(product.price).toFixed(2);
      qtyVal.textContent = String(selectedQty);

      cartModal.classList.add("on");
    }

    function closeCartModal(){
      cartModal.classList.remove("on");
      selectedProduct = null;
      selectedQty = 1;
    }

    qtyMinus.addEventListener("click", () => {
      selectedQty = Math.max(1, selectedQty - 1);
      qtyVal.textContent = String(selectedQty);
    });

    qtyPlus.addEventListener("click", () => {
      selectedQty = Math.min(99, selectedQty + 1);
      qtyVal.textContent = String(selectedQty);
    });

    cartCancelBtn.addEventListener("click", () => {
      closeCartModal();
      setStatus("تم الإلغاء.");
    });

    addToCartBtn.addEventListener("click", () => {
      if (!selectedProduct) { setStatus("لا يوجد منتج محدد."); return; }

      const sku = normalizeSku(selectedProduct.sku);
      if (!bill[sku]) {
        bill[sku] = {
          sku: sku,
          name: selectedProduct.name,
          price: Number(selectedProduct.price) || 0,
          qty: 0
        };
      }
      bill[sku].qty += selectedQty;

      renderBill();
      closeCartModal();
      setStatus(`تمت إضافة ${selectedProduct.name} (الكمية: ${selectedQty})`);
      showPage("bill");
    });

    viewOnMapBtn.addEventListener("click", () => {
      if (!selectedProduct) return;
      closeCartModal();
      navigateToQuery(selectedProduct.sku);
    });

    // =============================
    // Map click logic (Me / Product placement / Node actions)
    // =============================
    map.on('click', (e) => {
      let y = e.latlng.lat;
      let x = e.latlng.lng;

      const snapped = snapToMap(x, y);
      x = snapped.x; y = snapped.y;

      if (pickingMe) {
        pickingMe = false;
        userLayer.clearLayers();
        meMarker = L.marker([y, x]).addTo(userLayer);
        setStatus("تم تحديد موقعك");
        return;
      }

      // Admin: Save product location on map
      if (isAdmin && pickingProduct && pendingProduct) {
        pickingProduct = false;

        const res = addProductStrict({ ...pendingProduct, x, y });
        if (!res.ok) {
          setStatus(res.msg);
          pendingProduct = null;
          return;
        }

        saveProductsToLocalStorage();
        productLayer.clearLayers();
        L.marker([y, x]).addTo(productLayer);

        pendingProduct = null;
        document.getElementById("sku").value = "";
        document.getElementById("pname").value = "";
        document.getElementById("pprice").value = "";
        setStatus("تم حفظ المنتج على الخريطة");
        return;
      }

      // Admin: Add node
      if (isAdmin && mode === "addNode") {
        const id = "N" + (nodes.length + 1);
        nodes.push({ id, x, y, marker: null });
        redrawGraphLayers();
        setStatus("تم إضافة نقطة");
        return;
      }

      // Admin: Add edge
      if (isAdmin && mode === "addEdge") {
        const a = nearestNode(x, y);
        if (!a.node) { setStatus("لا يوجد نقاط."); return; }

        if (!selectedForEdge) {
          selectedForEdge = a.node;
          setStatus("اختر النقطة الثانية");
        } else {
          if (selectedForEdge.id === a.node.id) return;
          addEdgeBidirectional(selectedForEdge.id, a.node.id);
          selectedForEdge = null;
          setStatus("تم الربط");
        }
        return;
      }

      // Admin: Delete node
      if (isAdmin && mode === "deleteNode") {
        const hit = nearestNode(x, y);
        if (!hit.node || hit.d > NEAR_NODE_THRESHOLD) { setStatus("اقترب من النقطة لحذفها."); return; }

        const delId = hit.node.id;
        nodes = nodes.filter(n => n.id !== delId);

        delete edges[delId];
        for (const fromId in edges) {
          edges[fromId] = (edges[fromId] || []).filter(e => e.to !== delId);
        }

        redrawGraphLayers();
        setStatus("تم حذف النقطة: " + delId);
        return;
      }
    });

    // =============================
    // Search & Navigate (by name or sku) -> opens cart modal
    // =============================
    const scanResult = document.getElementById("scanResult");

    function navigateToQuery(raw){
      const q = (raw || "").trim();
      if (!q) { setStatus("اكتب اسم أو باركود."); return; }

      const item = findProductBySkuOrName(q);
      if (!item) { setStatus("المنتج غير موجود."); return; }

      if (!meMarker) { setStatus("حدد موقعك أولاً."); return; }
      if (nodes.length < 2) { setStatus("شبكة الممرات غير جاهزة."); return; }

      const mePos = meMarker.getLatLng();
      const startNode = nearestNode(mePos.lng, mePos.lat).node;
      const endNode = nearestNode(item.x, item.y).node;

      if (!startNode || !endNode) { setStatus("لا توجد نقاط ممر قريبة."); return; }

      const pathIds = dijkstra(startNode.id, endNode.id);
      if (!pathIds.length) { setStatus("لا يوجد مسار. الشبكة تحتاج ربط."); return; }

      const pathLatLngs = pathIds.map(id => {
        const n = nodes.find(nn => nn.id === id);
        return [n.y, n.x];
      });
      pathLatLngs.push([item.y, item.x]);

      productLayer.clearLayers();
      pathLayer.clearLayers();

      L.marker([item.y, item.x]).addTo(productLayer);

      L.polyline(pathLatLngs, { color: "#000000", weight: 12, opacity: 0.5, lineJoin: "round", lineCap: "round" }).addTo(pathLayer);
      L.polyline(pathLatLngs, { color: "#00c853", weight: 8, opacity: 0.95, lineJoin: "round", lineCap: "round" }).addTo(pathLayer);

      const group = L.featureGroup([meMarker, ...productLayer.getLayers(), ...pathLayer.getLayers()]);
      map.fitBounds(group.getBounds().pad(0.2));

      setStatus("تم رسم المسار إلى: " + item.name);
      showPage("map");
    }

    document.getElementById("go").addEventListener("click", () => {
      const raw = document.getElementById("q").value;
      const item = findProductBySkuOrName(raw);
      if (!item) { setStatus("المنتج غير موجود."); return; }
      openCartModal(item, "تم العثور على المنتج عبر البحث. اختر الكمية ثم أضف للعربة.");
    });

    // =============================
    // Camera Scanner (Barcode only) -> opens cart modal
    // =============================
    const scanOverlay = document.getElementById("scanOverlay");
    function overlayOn(){ if (scanOverlay) scanOverlay.classList.add("on"); }
    function overlayOff(){ if (scanOverlay) scanOverlay.classList.remove("on"); }

    const startScanBtn = document.getElementById("startScan");
    const stopScanBtn = document.getElementById("stopScan");

    const toggleManualBtn = document.getElementById("toggleManual");
    const manualBox = document.getElementById("manualBox");
    const manualCode = document.getElementById("manualCode");
    const manualOpenCart = document.getElementById("manualOpenCart");
    const manualSearch = document.getElementById("manualSearch");

    toggleManualBtn.addEventListener("click", () => {
      manualBox.style.display = (manualBox.style.display === "none") ? "block" : "none";
    });

    function openCartByCodeOrQuery(raw, sourceMsg){
      const item = findProductBySkuOrName(raw);
      if (!item) { setStatus("المنتج غير موجود / غير مسجّل."); scanResult.textContent = "المنتج غير مسجّل."; return; }
      openCartModal(item, sourceMsg);
    }

    manualOpenCart.addEventListener("click", () => {
      const code = (manualCode.value || "").trim();
      if (!code) { setStatus("أدخل باركود يدويًا."); return; }
      openCartByCodeOrQuery(code, "تم إدخال الباركود يدويًا. اختر الكمية ثم أضف للعربة.");
    });

    manualSearch.addEventListener("click", () => {
      const q = (manualCode.value || "").trim();
      if (!q) { setStatus("أدخل باركود/اسم يدويًا."); return; }
      openCartByCodeOrQuery(q, "بحث يدوي. اختر الكمية ثم أضف للعربة.");
    });

    let scanner = null;
    let scanning = false;
    let scanMode = "normal"; // normal | adminCapture
    let scanLock = false;

    function setScanText(msg){ scanResult.textContent = msg; }

    async function pickBackCameraId(){
      try{
        const devices = await Html5Qrcode.getCameras();
        if (!devices || !devices.length) return null;
        const preferred = devices.find(d => /back|rear|environment/i.test(d.label));
        return (preferred ? preferred.id : devices[devices.length - 1].id);
      } catch {
        return null;
      }
    }

    function barcodeFormatsOnly(){
      return [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.ITF,
        Html5QrcodeSupportedFormats.CODABAR,
        Html5QrcodeSupportedFormats.CODE_93
      ];
    }

    function looksLikeBarcode(text){
      const t = String(text||"").trim();
      if (!t) return false;
      if (/^https?:\/\//i.test(t)) return false;
      if (/[ \t]/.test(t)) return false;

      if (/^\d{8}$/.test(t)) return true;
      if (/^\d{12}$/.test(t)) return true;
      if (/^\d{13}$/.test(t)) return true;
      if (/^\d{14}$/.test(t)) return true;

      if (t.length >= 4 && t.length <= 32 && /^[A-Za-z0-9\-\._]+$/.test(t)) return true;
      return false;
    }

    async function startScanner(){
      if (scanning) return;
      scanning = true;

      try{
        if (!scanner) scanner = new Html5Qrcode("reader");

        setScanText("جارٍ تشغيل الكاميرا...");
        setStatus("تشغيل الكاميرا...");

        const camId = await pickBackCameraId();

        await scanner.start(
          camId ? { deviceId: { exact: camId } } : { facingMode: "environment" },
          {
            fps: 25,
            qrbox: (vw, vh) => {
              const width = Math.floor(Math.min(vw * 0.90, 440));
              const height = Math.floor(Math.min(vh * 0.40, 230));
              return { width, height };
            },
            formatsToSupport: barcodeFormatsOnly(),
            rememberLastUsedCamera: true,
            showTorchButtonIfSupported: true,
            showZoomSliderIfSupported: true,
            defaultZoomValueIfSupported: 2
          },
          async (decodedText) => {
            if (!scanning) return;
            if (scanLock) return;

            const code = String(decodedText||"").trim();
            if (!looksLikeBarcode(code)) return;

            scanLock = true;
            setScanText("تمت القراءة: " + code);

            // Admin: capture only
            if (isAdmin && scanMode === "adminCapture") {
              document.getElementById("sku").value = code;
              setStatus("تم التقاط الباركود للإدارة. أدخل الاسم والسعر ثم اضغط إضافة.");
              scanMode = "normal";
              scanLock = false;
              return;
            }

            // User: open cart modal (stop scanner to avoid repeated scans)
            await stopScanner(true);
            scanning = false;

            const item = products.find(p => normalizeSku(p.sku) === normalizeSku(code));
            if (!item) {
              setStatus("هذا الباركود غير مسجّل (اطلب من الإدارة إضافته).");
              setScanText("المنتج غير مسجّل.");
              scanLock = false;
              return;
            }

            openCartModal(item, "تم مسح الباركود. اختر الكمية ثم أضف للعربة.");
            scanLock = false;
          },
          () => {}
        );

        overlayOn();
        setScanText("الكاميرا جاهزة.");
        setStatus("الكاميرا تعمل");
      } catch (err){
        scanning = false;
        overlayOff();
        setScanText("تعذر تشغيل الكاميرا.");
        setStatus("فشل تشغيل الكاميرا (تأكد من HTTPS وإذن الكاميرا).");
        console.error(err);
      }
    }

    async function stopScanner(silent=false){
      if (!scanner) { scanning = false; overlayOff(); return; }
      try{
        if (scanner.isScanning) await scanner.stop();
        await scanner.clear();
      } catch(e){
        // ignore
      } finally {
        scanning = false;
        overlayOff();
        scanLock = false;
        if (!silent){
          setScanText("تم إيقاف الكاميرا.");
          setStatus("تم إيقاف الكاميرا");
        }
      }
    }

    startScanBtn.addEventListener("click", () => { scanMode = "normal"; startScanner(); });
    stopScanBtn.addEventListener("click", () => stopScanner(false));

    scanToAddBtn.addEventListener("click", () => {
      if (!isAdmin) return;
      scanMode = "adminCapture";
      showPage("scan");
      setStatus("امسح الباركود للإدارة (تعبئة الحقل فقط).");
      startScanner();
    });

    // =============================
    // Auto-load
    // =============================
    loadGraphFromLocalStorage();
    loadProductsFromLocalStorage();
    applyModeUI();
    renderBill();
    setStatus("جاهز");

    loggedIn = localStorage.getItem("logged_in_v3") === "1";
    if (!loggedIn) openLogin();

    setTimeout(() => map.invalidateSize(true), 300);
    setTimeout(() => map.invalidateSize(true), 900);
  </script>
</body>
</html>
